<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRC6998簽到系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #f4f7f6; text-align: center; padding: 20px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00B900; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status { margin-top: 20px; color: #333; font-weight: 500; line-height: 1.5; }
        .error { color: #d93025; font-weight: bold; }
    </style>
</head>
<body>
    <div id="icon" class="loader"></div>
    <div id="status">身分驗證中...</div>

    <script>
        const LIFF_ID = '2008914307-JOMdlPxS';

        async function main() {
            try {
                // 1. 初始化 LIFF
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // 2. 取得位置資訊
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // 執行簽到傳送
                    await submitCheckIn(lat, lng);
                }, (err) => {
                    showError("請開啟 GPS 定位權限");
                }, { enableHighAccuracy: true });

            } catch (err) {
                showError("系統初始化失敗");
            }
        }

        async function submitCheckIn(lat, lng) {
            try {
                // 讀取外部設定檔 (隱藏網址與 Token)
                const configRes = await fetch('./config.json');
                const config = await configRes.json();
                const profile = await liff.getProfile();

                // 傳送所有參數到後端進行「三重複核」
                fetch(config.gasUrl, {
                    method: 'POST',
                    mode: 'no-cors', 
                    body: JSON.stringify({
                        token: config.token,      // 識別碼驗證
                        userId: profile.userId,   // ID 驗證
                        userName: profile.displayName,
                        lat: lat,                 // 後端驗證座標
                        lng: lng
                    })
                }).then(() => {
                    document.getElementById('icon').style.display = 'none';
                    document.getElementById('status').innerHTML = "<h2 style='color: #00B900;'>✅ 簽到傳送完成</h2><p>後端正進行資格審查...</p>";
                    setTimeout(() => { liff.closeWindow(); }, 2000);
                });
            } catch (e) {
                showError("傳送失敗，請聯繫管理員");
            }
        }

        function showError(msg) {
            document.getElementById('icon').style.display = 'none';
            document.getElementById('status').innerHTML = `<span class="error">❌ ${msg}</span>`;
        }

        main();
    </script>
</body>
</html>
