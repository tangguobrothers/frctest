<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRC6998 簽到系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', -apple-system, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            margin: 0; 
            background: #f4f7f6; 
            color: #2c3e50;
        }

        .card {
            background: white;
            padding: 2.5rem 1.5rem;
            border-radius: 24px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.08);
            width: 85%;
            max-width: 350px;
            text-align: center;
        }

        h2 { margin-top: 0; margin-bottom: 1rem; font-weight: 700; color: #1a1a1a; }

        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #00B900; 
            border-radius: 50%; 
            width: 45px; 
            height: 45px; 
            animation: spin 1s linear infinite; 
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #status { 
            margin: 15px 0; 
            font-size: 1rem;
            line-height: 1.6; 
        }

        /* 距離提示樣式 */
        .distance-info {
            display: block;
            margin-top: 8px;
            font-size: 0.9rem;
            color: #7f8c8d;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 8px;
        }

        .error { color: #e74c3c; font-weight: bold; }
        .success { color: #27ae60; font-weight: bold; }
        .warning { color: #f39c12; font-weight: bold; }

        .btn-retry {
            display: none;
            background-color: #00B900;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 12px rgba(0,185,0,0.15);
            margin-top: 15px;
            width: 100%;
        }
        .btn-retry:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <div class="card">
        <h2>FRC6998 簽到</h2>
        <div id="icon" class="loader"></div>
        <div id="status">正在驗證您的位置與時間...</div>
        <button id="retryBtn" class="btn-retry" onclick="location.reload()">重新整理定位</button>
    </div>

    <script>
    const LIFF_ID = '2008914307-JOMdlPxS';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwG7_dYG9nq_oVg8Xq8Exte-rBxgcl_ZykvUQ4YgiZQL0RF48bYJLiol21KjrxwcjPffw/exec';

    const OFFICE_LAT = 23.107699;
    const OFFICE_LNG = 120.292136;
    const ALLOWED_DISTANCE = 0.1; // 100公尺

    function generateToken() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const makeRandom = (len) => Array.from({ length: len }, () => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
        const now = new Date();
        const timeStr = String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + String(now.getHours()).padStart(2, '0');
        return makeRandom(20) + timeStr + makeRandom(24);
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }

    function showError(msg, distance = null) {
        document.getElementById('icon').style.display = 'none';
        let content = `<span class="error">${msg}</span>`;
        
        // 如果有距離資訊，顯示出來
        if (distance !== null) {
            const meters = Math.round(distance * 1000);
            content += `<br><span class="distance-info">目前與工作室距離：${meters} 公尺</span>`;
        }
        
        document.getElementById('status').innerHTML = content;
        document.getElementById('retryBtn').style.display = 'block';
    }

    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            const now = new Date();
            const totalMinutes = now.getHours() * 60 + now.getMinutes();
            let timeStatus = "";

            // 時間判斷邏輯
            if (totalMinutes >= 7 * 60 && totalMinutes <= 12 * 60) {
                timeStatus = (totalMinutes <= 9 * 60 + 5) ? "<span class='success'>☀️ 上午：出席狀態</span>" : "<span class='warning'>⚠️ 上午：遲到狀態</span>";
            } else if (totalMinutes > 12 * 60 && totalMinutes <= 23 * 60 + 59) {
                timeStatus = (totalMinutes <= 13 * 60 + 35) ? "<span class='success'>☕ 下午：出席狀態</span>" : "<span class='warning'>⚠️ 下午：遲到狀態</span>";
            } else {
                showError("❌ 非簽到時段<br>目前時間不在開放範圍內");
                document.getElementById('retryBtn').style.display = 'none';
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const distance = getDistance(position.coords.latitude, position.coords.longitude, OFFICE_LAT, OFFICE_LNG);
                
                if (distance <= ALLOWED_DISTANCE) {
                    document.getElementById('status').innerHTML = `位置驗證成功...<br>${timeStatus}`;
                    submitCheckIn();
                } else {
                    showError("❌ 區域限制<br>您目前不在工作室範圍內", distance);
                }
            }, (err) => {
                showError("❌ 無法取得位置<br>請檢查手機 GPS 權限");
            }, { enableHighAccuracy: true, timeout: 10000 });

        } catch (err) {
            showError("初始化失敗: " + err);
        }
    }

    async function submitCheckIn() {
        try {
            const profile = await liff.getProfile();
            const token = generateToken();

            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    userId: profile.userId,
                    userName: profile.displayName,
                    token: token
                })
            }).then(() => {
                document.getElementById('icon').style.display = 'none';
                document.getElementById('status').innerHTML = "<h2 style='color: #00B900;'>✅ 簽到成功</h2><p>系統已記錄您的出席</p>";
                setTimeout(() => { liff.closeWindow(); }, 2200);
            });
        } catch (e) {
            showError("傳送失敗，請重新整理");
        }
    }

    main();
    </script>
</body>
</html>
